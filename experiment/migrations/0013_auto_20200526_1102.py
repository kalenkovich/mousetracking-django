# Generated by Django 2.2.12 on 2020-05-26 08:02
from pathlib import Path

from django.db import migrations
from django.templatetags.static import static


def wipe_all(apps, schema_editor):
    tables = [apps.get_model('experiment', model)
              for model in ('TrialResults', 'Trial', 'Audio', 'Image', 'Participant')]
    for table in tables:
        table.objects.all().delete()


def populate_images_and_audio(apps, schema_editor):
    static_dir = Path('experiment/static/')

    Image = apps.get_model('experiment', 'Image')
    objects_dir = static_dir / 'experiment' / 'objects'
    for png in objects_dir.glob('*.png'):
        Image.objects.create(name=png.stem, uri=png.relative_to(static_dir))

    Audio = apps.get_model('experiment', 'Audio')
    objects_dir = static_dir / 'experiment' / 'audio' / 'ogg'
    for ogg in objects_dir.glob('*.ogg'):
        Audio.objects.create(name=ogg.stem, uri=ogg.relative_to(static_dir))


class Migration(migrations.Migration):

    dependencies = [
        ('experiment', '0012_participant_session'),
    ]

    operations = [
        migrations.RunPython(wipe_all),
        migrations.RunPython(populate_images_and_audio),
    ]
